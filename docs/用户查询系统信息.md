# 用户查询系统信息功能说明

## 1. 功能概述

根据课程设计要求："用户可以查询所设计系统的相关信息"，本系统为不同角色用户提供了相应的系统信息查询功能。

## 2. 普通用户查询功能

### 2.1 个人文件统计

**查询位置**: 用户仪表盘

**可查询信息**:
- 个人文件总数
- 已用存储空间
- 存储配额
- 存储使用百分比

**实现方式**: 
- 前端: `src/views/UserDashboard.vue`
- 后端: `/api/files/list` API返回文件列表，前端计算统计信息

**SQL查询示例**:
```sql
-- 查询用户文件总数
SELECT COUNT(*) FROM files WHERE user_id = ? AND type != 'folder';

-- 查询用户已用存储
SELECT SUM(size_bytes) FROM files WHERE user_id = ? AND type != 'folder';

-- 查询用户存储配额
SELECT storage_quota, storage_used FROM users WHERE id = ?;
```

### 2.2 个人分享统计

**查询位置**: "我的分享"标签页

**可查询信息**:
- 分享文件总数
- 每个分享的访问次数
- 分享有效期
- 分享状态（有效/已过期）

**实现方式**:
- 前端: `src/components/ShareList.vue`
- 后端: `/api/shares/list` API返回用户分享列表

**SQL查询示例**:
```sql
-- 查询用户分享列表
SELECT * FROM shares WHERE user_id = ? ORDER BY created_at DESC;
```

### 2.3 文件分类统计

**查询位置**: 文件列表（通过标签页）

**可查询信息**:
- 全部文件数量
- 最近7天上传的文件数量
- 收藏的文件数量
- 已分享的文件数量

**实现方式**:
- 前端: `src/views/UserDashboard.vue` - 标签页切换
- 后端: `/api/files/list?tab={tab}` API根据标签返回对应文件

**SQL查询示例**:
```sql
-- 查询最近7天的文件
SELECT * FROM files 
WHERE user_id = ? 
  AND type != 'folder' 
  AND created_at > (unixepoch() - 7 * 24 * 60 * 60)
ORDER BY created_at DESC;

-- 查询收藏的文件
SELECT * FROM files 
WHERE user_id = ? 
  AND starred = 1 
ORDER BY created_at DESC;
```

### 2.4 文件操作历史（通过系统日志）

**查询位置**: 系统日志（管理员功能，但用户可以通过API查询自己的日志）

**可查询信息**:
- 文件上传记录
- 文件下载记录
- 文件删除记录
- 分享创建记录

**实现方式**:
- 后端: `/api/admin/logs` API（需要管理员权限）
- 可以为普通用户添加 `/api/logs` API查询自己的日志

**SQL查询示例**:
```sql
-- 查询用户操作日志
SELECT * FROM system_logs 
WHERE user_id = ? 
ORDER BY created_at DESC 
LIMIT 100;
```

## 3. 管理员查询功能

### 3.1 系统整体统计

**查询位置**: 管理面板 → 仪表盘

**可查询信息**:
- 总用户数
- 活跃用户数
- 总文件数
- 总存储使用量
- 可用存储空间
- R2存储桶数量
- 系统日志总数

**实现方式**:
- 前端: `src/views/AdminDashboard.vue`
- 后端: `/api/admin/stats` API

**SQL查询示例**:
```sql
-- 查询总用户数
SELECT COUNT(*) as total_users FROM users;

-- 查询活跃用户数
SELECT COUNT(*) as active_users FROM users WHERE status = '活跃';

-- 查询总文件数
SELECT COUNT(*) as total_files FROM files WHERE type != 'folder';

-- 查询总存储使用量
SELECT SUM(size_bytes) as total_size FROM files WHERE type != 'folder';
```

### 3.2 用户详细信息查询

**查询位置**: 管理面板 → 用户管理

**可查询信息**:
- 所有用户列表
- 用户基本信息（姓名、邮箱、角色、状态）
- 用户存储使用情况
- 用户所属用户组

**实现方式**:
- 前端: `src/components/UserTable.vue`
- 后端: `/api/admin/users` API

**SQL查询示例**:
```sql
-- 查询所有用户
SELECT 
  u.id, u.name, u.email, u.role, u.status,
  u.storage_quota, u.storage_used, u.group_id,
  g.name as group_name
FROM users u
LEFT JOIN user_groups g ON u.group_id = g.id
ORDER BY u.created_at DESC;
```

### 3.3 文件管理查询

**查询位置**: 管理面板 → 文件管理

**可查询信息**:
- 所有用户上传的文件
- 文件详细信息（文件名、大小、类型、上传者、上传时间）
- 文件分享状态
- 文件下载次数

**实现方式**:
- 前端: `src/components/FileTable.vue`
- 后端: `/api/admin/files` API

**SQL查询示例**:
```sql
-- 查询所有文件
SELECT 
  f.id, f.name, f.size_bytes, f.type, f.created_at,
  u.name as uploader, u.email as uploader_email,
  f.download_count,
  CASE WHEN s.id IS NOT NULL THEN '已分享' ELSE '未分享' END as share_status
FROM files f
JOIN users u ON f.user_id = u.id
LEFT JOIN shares s ON f.id = s.file_id AND s.expires_at > unixepoch()
WHERE f.type != 'folder'
ORDER BY f.created_at DESC;
```

### 3.4 存储管理查询

**查询位置**: 管理面板 → 存储管理

**可查询信息**:
- 总存储容量
- 已用存储空间
- 可用存储空间
- 存储使用百分比
- R2存储桶信息
- 总文件数

**实现方式**:
- 前端: `src/components/StorageManagement.vue`
- 后端: `/api/admin/stats` API

### 3.5 系统日志查询

**查询位置**: 管理面板 → 系统日志

**可查询信息**:
- 所有系统操作日志
- 操作类型、操作者、操作时间
- 操作状态（成功/警告/失败）
- 操作详情和IP地址

**实现方式**:
- 前端: `src/components/LogTable.vue`
- 后端: `/api/admin/logs` API

**SQL查询示例**:
```sql
-- 查询系统日志
SELECT 
  id, action, user_name, status, details, ip,
  file_name, created_at
FROM system_logs
ORDER BY created_at DESC
LIMIT 100;
```

### 3.6 用户组查询

**查询位置**: 管理面板 → 用户组

**可查询信息**:
- 所有用户组列表
- 用户组基本信息（名称、描述、存储配额）
- 用户组成员数量
- 用户组最大用户数

**实现方式**:
- 前端: `src/components/UserGroupManagement.vue`
- 后端: `/api/admin/groups` API

**SQL查询示例**:
```sql
-- 查询用户组
SELECT 
  id, name, description, storage_quota, max_users, current_users
FROM user_groups
ORDER BY created_at DESC;
```

## 4. 访客查询功能

### 4.1 文件信息查询（通过分享码）

**查询位置**: 提取页面 `/extract/{code}`

**可查询信息**:
- 文件名称
- 文件大小
- 文件类型
- 上传时间
- 下载链接

**实现方式**:
- 前端: `src/views/ExtractPage.vue`
- 后端: `/api/extract/{code}` API

**SQL查询示例**:
```sql
-- 通过分享码查询文件信息
SELECT 
  f.id, f.name, f.size_bytes, f.type, f.created_at,
  s.share_code, s.expires_at, s.access_count
FROM shares s
JOIN files f ON s.file_id = f.id
WHERE s.share_code = ? 
  AND s.expires_at > unixepoch();
```

## 5. 查询功能实现代码

### 5.1 前端查询实现

**用户仪表盘统计查询** (`src/views/UserDashboard.vue`):
```typescript
// 计算个人文件统计
const fileStats = computed(() => {
  const allFiles = fileStore.files
  const totalFiles = getAllFilesFlat(allFiles).filter(f => f.type !== 'folder').length
  const totalSize = getAllFilesFlat(allFiles)
    .filter(f => f.type !== 'folder')
    .reduce((sum, f) => sum + parseFileSize(f.size), 0)
  
  return {
    totalFiles,
    totalSize,
    // ... 其他统计
  }
})
```

**管理员统计查询** (`src/stores/admin.ts`):
```typescript
// 从 API 获取存储统计
const fetchStorageStats = async () => {
  const response = await get<StorageStats>('/admin/stats')
  if (response.success && response.data) {
    storageStats.value = response.data
  }
}
```

### 5.2 后端查询实现

**系统统计查询** (`server/functions/api/admin/stats.ts`):
```typescript
const stats = await db.getStorageStats()

return new Response(
  JSON.stringify({
    success: true,
    data: {
      totalStorage: 1024, // GB
      usedStorage: stats.totalSize / (1024 * 1024 * 1024),
      availableStorage: 1024 - usedStorage,
      totalFiles: stats.totalFiles,
      totalUsers: stats.totalUsers,
      activeUsers: stats.activeUsers
    }
  })
)
```

**数据库查询方法** (`server/src/utils/db.ts`):
```typescript
async getStorageStats() {
  const totalFiles = await this.db
    .prepare('SELECT COUNT(*) as count FROM files WHERE type != "folder"')
    .first<{ count: number }>()
  
  const totalSize = await this.db
    .prepare('SELECT SUM(size_bytes) as total FROM files WHERE type != "folder"')
    .first<{ total: number }>()
  
  const totalUsers = await this.db
    .prepare('SELECT COUNT(*) as count FROM users')
    .first<{ count: number }>()
  
  const activeUsers = await this.db
    .prepare('SELECT COUNT(*) as count FROM users WHERE status = "活跃"')
    .first<{ count: number }>()
  
  return {
    totalFiles: totalFiles?.count || 0,
    totalSize: totalSize?.total || 0,
    totalUsers: totalUsers?.count || 0,
    activeUsers: activeUsers?.count || 0
  }
}
```

## 6. 查询功能总结

### 6.1 普通用户可查询的信息

✅ **个人文件统计**: 文件数量、存储使用情况  
✅ **个人分享统计**: 分享列表、访问次数  
✅ **文件分类统计**: 全部/最近/收藏/分享的文件  
✅ **文件详细信息**: 文件名、大小、类型、上传时间  

### 6.2 管理员可查询的信息

✅ **系统整体统计**: 用户数、文件数、存储使用  
✅ **用户详细信息**: 所有用户列表及详细信息  
✅ **文件管理信息**: 所有文件及详细信息  
✅ **存储管理信息**: 存储使用统计  
✅ **系统日志信息**: 所有操作日志  
✅ **用户组信息**: 用户组列表及配置  

### 6.3 访客可查询的信息

✅ **分享文件信息**: 通过分享码查询文件基本信息  

## 7. 查询性能优化

1. **索引优化**: 在常用查询字段上创建索引
2. **分页查询**: 大量数据使用分页，避免一次性加载
3. **缓存机制**: 统计数据可以缓存，减少数据库查询
4. **聚合查询**: 使用SQL聚合函数，减少多次查询

## 8. 查询功能截图说明

（注：此处需要组员2提供实际运行截图）

- 用户仪表盘统计信息截图
- 管理员系统概览截图
- 存储管理统计截图
- 系统日志查询截图

