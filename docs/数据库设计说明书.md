# 基于分布式对象存储的云端文件存储与共享系统  
数据库设计说明书（Markdown 版）

> 关联代码路径：`server/src/db/schema.sql`、`server/src/db/migrations/001_initial.sql`、`server/src/db/seed.sql`。后端基于 Cloudflare Workers + D1 + R2，前端基于 Vue/Vite。

## 1 引言
- 背景：传统将大文件以 BLOB 存进单机关系库会导致体积膨胀、I/O 下降、扩展与容灾困难。  
- 目标：采用“存算分离”架构，数据库只存元数据与权限，文件实体存入对象存储；通过预签名 URL 直传/直下，获得高并发、低延迟。  
- 范围：覆盖需求分析、概念/逻辑设计、实现、测试、权限、安全、团队分工与心得，作为课程设计报告正文。

## 2 系统与需求
### 2.1 角色与功能
- 访客：输入 6 位分享码，校验有效期后获取下载链接。  
- 注册用户：注册/登录；上传文件写入元数据；查看/搜索/星标/删除（软删）文件；创建分享码；查看访问次数。  
- 管理员：全表 CRUD；管理用户与用户组、存储后端、组存储配额；查看系统日志与用量统计；对违规文件强制下架。  
- 用户组：可配置配额与权限，用于批量管理用户能力。

### 2.2 约束与假设
- 存算分离：大对象存 R2，D1 仅存元数据；任何文件访问都先查元数据、鉴权再生成预签名 URL。  
- 安全：密码存储使用哈希；分享码唯一；支持过期时间与最大访问次数；日志记录关键操作。  
- 配额：用户/组层面存储配额，支持管理员分配共享存储后端。  
- DFD（文字描述）：  
  - 上传：用户→Auth→(鉴权)→生成 R2 预签名 PUT→用户直传 R2→回写 `files`。  
  - 下载：访客/用户→输入分享码→查 `shares`+`files` 状态与有效期→生成 R2 预签名 GET→直下。  
  - 管理：管理员→用户/文件/日志/存储后端表的增删改查。

## 3 概念结构设计（E-R 描述）
- 实体：Users、UserGroups、Files、Shares、StorageBackends、UserStorageBackends、GroupStorageAllocations、SystemLogs。  
- 关系：  
  - User 1:N File（拥有文件/文件夹）。  
  - File 1:N Share（一个文件可生成多条分享记录）。  
  - User 1:N Share（谁创建的分享）。  
  - User 1:N SystemLog（谁触发的操作）。  
  - User N:1 UserGroup；UserGroup N:M StorageBackend（通过 GroupStorageAllocations）。  
  - User 1:N UserStorageBackend（用户自有存储配置）。  
（实际 ER 图请在答辩材料中插入）

## 4 逻辑结构设计（3NF）
各表字段基于 `server/src/db/schema.sql`，均满足 3NF（非键列完全依赖主键，无传递依赖；枚举/状态使用 CHECK 控制）。

### 4.1 表与关键字段
- `users`：`id` (PK, TEXT)，`name`，`email` UNIQUE，`phone` UNIQUE，`password_hash`，`role` ENUM('admin','user')，`status` ENUM('活跃','已暂停')，`storage_quota/used`，`group_id`，`avatar_url`，`created_at/updated_at`。邮箱与手机号至少填一项（CHECK）。  
- `user_groups`：用户组配额、人数与权限(JSON)。  
- `files`：`id` (PK AUTOINCREMENT)，`name`，`size_bytes`，`mime_type`，`storage_key`，`storage_backend_id`，`user_id` FK→users，`parent_id` FK→files（树形目录），`path`，`type` ENUM('folder','pdf','image','video','zip','code')，`starred`，`download_count`，`created_at/updated_at`。  
- `shares`：`id` (TEXT PK)，`file_id` FK，`user_id` FK，`share_code` UNIQUE，`expiration_days`，`expires_at`，`access_count`，`max_access`。  
- `storage_backends`：系统/管理员提供的存储后端（r2/s3/webdav/ftp/sftp），含 JSON 配置、启用/默认/共享标记。  
- `user_storage_backends`：用户自有存储后端，配置加密存放。  
- `group_storage_allocations`：用户组与存储后端的配额分配（quota/used）。  
- `system_logs`：`action`、`status`('成功','警告','失败')、`user_id`、`file_id`、`ip`、`details`、`created_at`。  
- 索引：邮箱、phone、files(user_id/parent_id/path/storage_backend_id)、shares(share_code/file_id/user_id)、logs(created_at) 等，见 schema。

### 4.2 数据字典（示例）
| 表 | 字段 | 含义 | 约束/备注 |
| --- | --- | --- | --- |
| users | role | 角色 | CHECK in ('admin','user') |
| files | storage_key | R2/S3 对象键 | UNIQUE |
| shares | share_code | 6 位提取码 | UNIQUE，不可为空 |
| shares | expires_at | 过期时间 | 大于 created_at |
| group_storage_allocations | quota_gb | 分配容量 | REAL, >=0 |
| system_logs | status | 结果 | CHECK in ('成功','警告','失败') |

## 5 物理实现与环境
- 数据库：Cloudflare D1（边缘分布式 SQL）。  
- 存储：Cloudflare R2（对象存储）。  
- 后端：Cloudflare Workers/Pages Functions，按请求创建 D1 连接，避免传统连接池开销。  
- 时间字段：使用 `unixepoch()`（秒级），便于边缘环境统一。  
- 编码与排序：D1 SQLite 兼容；文本字段使用 TEXT。

## 6 迁移与种子
- 初始化迁移：`server/src/db/migrations/001_initial.sql`（users/user_groups/files/shares/system_logs + 索引）。  
- 当前 schema：`server/src/db/schema.sql`（包含存储后端与配额扩展表）。  
- 种子数据：`server/src/db/seed.sql` 创建默认管理员 `admin@simpleshare.com`（密码哈希示例）与基础用户组。

## 7 关键流程与示例 SQL
- 注册：`INSERT INTO users ...`（校验 email/phone 唯一）。  
- 登录：按 email 取 `password_hash/role/status`，验证后签发会话/JWT。  
- 上传入库：生成 R2 预签名 PUT；完成后写入 `files(name,size_bytes,storage_key,user_id,path,type)`。  
- 创建分享：`INSERT INTO shares(file_id,user_id,share_code,expires_at,expiration_days)`；share_code 需唯一。  
- 校验分享下载：查询 `shares` + `files.status` + `expires_at` + `max_access`；计数 `access_count += 1`；生成 R2 预签名 GET。  
- 软删文件：`UPDATE files SET type='folder'/status ？`（现 schema 用 status? 文件表未设 status，可通过业务逻辑/存储_key 置无效并记录日志）；同时可删除/失效相关 share。  
- 日志：对登录、上传、删除、分享创建/访问写入 `system_logs`。

## 8 权限与安全
- 角色：`role` 字段区分 admin/user；管理员全表 CRUD。  
- 所有权：用户仅能操作自己 `user_id` 关联的文件/分享；管理员可越权。  
- 分享控制：过期时间、最大访问次数、分享码唯一；可加速率限制/验证码。  
- 配额控制：`storage_quota/used` 与 `group_storage_allocations`；上传前校验剩余空间。  
- 敏感配置：`user_storage_backends.config_encrypted` 需加密存储。  
- 审计：`system_logs` 记录 IP/UA/动作结果，便于追踪。

## 9 测试与验证（示例用例）
- 账户：注册重复邮箱/电话应失败；禁用状态用户无法登录。  
- 上传：超出配额阻断；上传后文件列表可见且 size/mime/path 正确。  
- 分享：  
  - 正常分享返回 6 位码；过期后访问被拒。  
  - `max_access` 用尽后拒绝访问。  
  - 删除文件后分享失效。  
- 权限：普通用户不能删除他人文件；管理员可强制删除。  
- 日志：登录失败/成功各写一条；文件下载/删除有记录。  
- 存储后端：禁用的后端不可被分配或使用。  
- 迁移/种子：初始化无错误，可重复执行（使用 IF NOT EXISTS / OR IGNORE）。

## 10 运维与改进
- 生命周期：为 R2 开启生命周期策略清理已删除对象。  
- 观测性：对 Workers 记录请求耗时/错误率；D1 查询慢日志。  
- 性能：对分享校验与文件列表使用索引字段查询；如需全文搜索可引入外部索引。  
- 异常与告警：分享暴力猜测时进行速率限制与告警。  
- 数据一致性：删除文件需同步失效分享与回收配额；可用事务封装。

## 11 交付与答辩要点
- 交付物：设计说明书（PDF/Word）、答辩 PPT、核心代码/SQL 附录。  
- 答辩 7 分钟建议顺序：背景→需求→ER/DFD→3NF 表设计→关键 SQL/接口→权限与安全→测试结果→创新点（边缘 + 存算分离 + 多存储后端）→不足与改进。

## 12 团队分工（示例）
- 明航宇（队长）：全栈开发、架构与部署、任务分配。  
- 组员1：数据建模、ER/DFD 绘制、数据字典与 SQL 规范。  
- 组员2：测试与数据填充、运行截图与用例设计。  
- 组员3：需求背景撰写与文档排版统筹。  
- 组员4：答辩 PPT、用户操作手册、演示支持。

## 13 心得体会（提炼）
- 存算分离在文件场景显著降低数据库 IO 与容量压力。  
- 边缘数据库（D1）免维护连接池，搭配 R2 实现全球低延迟访问。  
- 规范的角色/配额/日志设计让权限与追责更清晰。  
- 团队分工与接口/命名/测试规范对交付质量和进度至关重要；后续可加强分片上传、速率限制、防撞库与日志归档。

