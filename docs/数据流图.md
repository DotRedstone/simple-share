# SimpleShare 数据流图 (DFD)

## 1. 顶层数据流图 (Context Diagram)

```
                    ┌─────────────┐
                    │  访客/用户   │
                    └──────┬──────┘
                           │
                    ┌──────▼──────────────────────────────┐
                    │                                      │
                    │      SimpleShare 文件管理系统        │
                    │                                      │
                    │  - 用户注册/登录                     │
                    │  - 文件上传/下载                     │
                    │  - 文件分享                          │
                    │  - 系统管理                          │
                    │                                      │
                    └──────┬───────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐      ┌──────▼──────┐    ┌─────▼─────┐
   │ Cloudflare D1 │  │ Cloudflare R2 │  │ 系统日志  │
   │   (元数据)     │  │  (文件实体)    │  │          │
   └───────────────┘  └──────────────┘  └───────────┘
```

## 2. 0层数据流图 (Level 0 DFD)

```
┌─────────────────────────────────────────────────────────────────┐
│                      SimpleShare 系统                            │
│                                                                   │
│  ┌──────────┐         ┌──────────┐         ┌──────────┐        │
│  │ 用户管理  │         │ 文件管理  │         │ 分享管理  │        │
│  │ 处理     │         │ 处理     │         │ 处理     │        │
│  └────┬─────┘         └────┬─────┘         └────┬─────┘        │
│       │                    │                    │              │
│       │                    │                    │              │
│  ┌────▼────────────────────▼────────────────────▼──────┐      │
│  │              数据库访问层                             │      │
│  └────┬────────────────────┬────────────────────┬──────┘      │
│       │                    │                    │              │
│  ┌────▼────┐        ┌─────▼─────┐      ┌──────▼──────┐      │
│  │ 用户数据 │        │ 文件元数据 │      │ 分享数据     │      │
│  │ (D1)    │        │ (D1)       │      │ (D1)         │      │
│  └─────────┘        └────────────┘      └──────────────┘      │
│                                                               │
│  ┌──────────┐                                               │
│  │ 文件存储  │                                               │
│  │ (R2)     │                                               │
│  └──────────┘                                               │
└───────────────────────────────────────────────────────────────┘
```

## 3. 1层数据流图 - 用户管理 (Level 1 DFD - User Management)

```
用户
 │
 │ 注册请求(用户名, 邮箱, 密码)
 ├─────────────────────────────────┐
 │                                  │
 │                                  ▼
 │                          ┌──────────────┐
 │                          │ 用户注册处理  │
 │                          └──────┬───────┘
 │                                 │
 │                                 │ 验证信息
 │                                 ▼
 │                          ┌──────────────┐
 │                          │ 密码哈希处理  │
 │                          └──────┬───────┘
 │                                 │
 │                                 │ 用户数据
 │                                 ▼
 │                          ┌──────────────┐
 │                          │ 写入users表  │
 │                          └──────────────┘
 │
 │ 登录请求(用户名/邮箱, 密码)
 ├─────────────────────────────────┐
 │                                  │
 │                                  ▼
 │                          ┌──────────────┐
 │                          │ 用户登录处理  │
 │                          └──────┬───────┘
 │                                 │
 │                                 │ 查询用户
 │                                 ▼
 │                          ┌──────────────┐
 │                          │ 读取users表   │
 │                          └──────┬───────┘
 │                                 │
 │                                 │ 验证密码
 │                                 ▼
 │                          ┌──────────────┐
 │                          │ 生成JWT Token│
 │                          └──────┬───────┘
 │                                 │
 │                                 │ Token
 │                                 ▼
 │                                用户
```

## 4. 1层数据流图 - 文件管理 (Level 1 DFD - File Management)

```
用户
 │
 │ 上传请求(文件, 元数据)
 ├─────────────────────────────────┐
 │                                  │
 │                                  ▼
 │                          ┌──────────────┐
 │                          │ 文件上传处理  │
 │                          └──────┬───────┘
 │                                 │
 │                    ┌────────────┼────────────┐
 │                    │            │            │
 │                    ▼            ▼            ▼
 │            ┌──────────┐  ┌──────────┐  ┌──────────┐
 │            │ 检查配额  │  │ 生成存储  │  │ 提取元   │
 │            │          │  │ Key      │  │ 数据     │
 │            └────┬─────┘  └────┬─────┘  └────┬────┘
 │                 │              │            │
 │                 │              │            │
 │                 └──────────────┼────────────┘
 │                                │
 │                    ┌───────────┼───────────┐
 │                    │           │           │
 │                    ▼           ▼           ▼
 │            ┌──────────┐  ┌──────────┐  ┌──────────┐
 │            │ 更新用户  │  │ 写入files│  │ 上传文件  │
 │            │ 存储使用  │  │ 表(元数据)│  │ 到R2     │
 │            └──────────┘  └──────────┘  └──────────┘
 │
 │ 下载请求(文件ID)
 ├─────────────────────────────────┐
 │                                  │
 │                                  ▼
 │                          ┌──────────────┐
 │                          │ 文件下载处理  │
 │                          └──────┬───────┘
 │                                 │
 │                                 │ 查询文件
 │                                 ▼
 │                          ┌──────────────┐
 │                          │ 读取files表  │
 │                          └──────┬───────┘
 │                                 │
 │                                 │ 获取存储Key
 │                                 ▼
 │                          ┌──────────────┐
 │                          │ 生成预签名URL│
 │                          └──────┬───────┘
 │                                 │
 │                                 │ 下载链接
 │                                 ▼
 │                                用户
```

## 5. 1层数据流图 - 分享管理 (Level 1 DFD - Share Management)

```
用户
 │
 │ 创建分享请求(文件ID, 有效期)
 ├─────────────────────────────────┐
 │                                  │
 │                                  ▼
 │                          ┌──────────────┐
 │                          │ 分享创建处理  │
 │                          └──────┬───────┘
 │                                 │
 │                    ┌────────────┼────────────┐
 │                    │            │            │
 │                    ▼            ▼            ▼
 │            ┌──────────┐  ┌──────────┐  ┌──────────┐
 │            │ 验证文件  │  │ 生成分享  │  │ 计算过期  │
 │            │ 所有权   │  │ 码(6位)  │  │ 时间     │
 │            └────┬─────┘  └────┬─────┘  └────┬────┘
 │                 │              │            │
 │                 └──────────────┼────────────┘
 │                                │
 │                                │ 分享数据
 │                                ▼
 │                          ┌──────────────┐
 │                          │ 写入shares表 │
 │                          └──────────────┘
 │
 │ 提取请求(分享码)
 ├─────────────────────────────────┐
 │                                  │
 │                                  ▼
 │                          ┌──────────────┐
 │                          │ 分享验证处理  │
 │                          └──────┬───────┘
 │                                 │
 │                                 │ 查询分享
 │                                 ▼
 │                          ┌──────────────┐
 │                          │ 读取shares表 │
 │                          └──────┬───────┘
 │                                 │
 │                    ┌────────────┼────────────┐
 │                    │            │            │
 │                    ▼            ▼            ▼
 │            ┌──────────┐  ┌──────────┐  ┌──────────┐
 │            │ 验证有效  │  │ 验证访问  │  │ 获取文件  │
 │            │ 期       │  │ 次数     │  │ 信息     │
 │            └────┬─────┘  └────┬─────┘  └────┬────┘
 │                 │              │            │
 │                 └──────────────┼────────────┘
 │                                │
 │                                │ 文件信息
 │                                ▼
 │                                访客
```

## 6. 数据流说明

### 6.1 主要数据流

| 数据流名称 | 起点 | 终点 | 说明 |
|-----------|------|------|------|
| 用户注册信息 | 用户 | 用户注册处理 | 用户名、邮箱、密码 |
| 用户登录信息 | 用户 | 用户登录处理 | 用户名/邮箱、密码 |
| JWT Token | 用户登录处理 | 用户 | 认证令牌 |
| 文件上传数据 | 用户 | 文件上传处理 | 文件内容、元数据 |
| 文件元数据 | 文件上传处理 | files表 | 文件名、大小、类型等 |
| 文件实体 | 文件上传处理 | R2存储 | 文件二进制数据 |
| 存储Key | files表 | 文件下载处理 | R2对象标识 |
| 预签名URL | 文件下载处理 | 用户 | 临时下载链接 |
| 分享创建请求 | 用户 | 分享创建处理 | 文件ID、有效期 |
| 分享码 | 分享创建处理 | shares表 | 6位提取码 |
| 提取码验证 | 访客 | 分享验证处理 | 6位分享码 |
| 文件信息 | 分享验证处理 | 访客 | 文件元数据、下载链接 |

### 6.2 数据存储

| 数据存储 | 说明 | 存储位置 |
|---------|------|---------|
| users | 用户信息 | Cloudflare D1 |
| files | 文件元数据 | Cloudflare D1 |
| shares | 分享记录 | Cloudflare D1 |
| user_groups | 用户组信息 | Cloudflare D1 |
| system_logs | 系统日志 | Cloudflare D1 |
| 文件实体 | 实际文件内容 | Cloudflare R2 |

### 6.3 处理说明

| 处理名称 | 输入 | 输出 | 说明 |
|---------|------|------|------|
| 用户注册处理 | 注册信息 | 用户记录 | 验证信息、哈希密码、创建用户 |
| 用户登录处理 | 登录信息 | JWT Token | 验证身份、生成令牌 |
| 文件上传处理 | 文件数据 | 文件元数据、存储Key | 检查配额、上传到R2、记录元数据 |
| 文件下载处理 | 文件ID | 预签名URL | 查询元数据、生成下载链接 |
| 分享创建处理 | 文件ID、有效期 | 分享码 | 生成分享码、记录分享信息 |
| 分享验证处理 | 分享码 | 文件信息 | 验证有效性、返回文件信息 |

## 7. 数据流图绘制说明

本系统采用**存算分离**架构：

1. **元数据流**: 所有文件元数据（文件名、大小、路径等）存储在 D1 数据库中，查询速度快
2. **文件实体流**: 实际文件内容存储在 R2 对象存储中，通过预签名URL访问
3. **权限验证流**: 所有操作都经过JWT认证，确保数据安全
4. **日志记录流**: 所有关键操作都记录到system_logs表，便于审计

这种设计实现了：
- **高性能**: 元数据查询毫秒级响应
- **高可用**: 文件存储分布式，自动备份
- **高扩展**: 存储容量可无限扩展
- **低成本**: 按需付费，无需维护服务器

