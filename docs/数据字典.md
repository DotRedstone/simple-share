# SimpleShare 数据字典

## 1. 数据项说明

### 1.1 用户相关数据项

| 数据项名称 | 数据类型 | 长度 | 说明 | 取值范围 |
|-----------|---------|------|------|---------|
| 用户ID | TEXT | 可变 | 用户唯一标识符 | 格式：usr_时间戳_随机字符串 |
| 用户名 | TEXT | 可变 | 用户显示名称 | 1-50个字符 |
| 邮箱 | TEXT | 可变 | 用户邮箱地址 | 符合邮箱格式，唯一 |
| 密码哈希 | TEXT | 64 | SHA-256哈希值 | 64位十六进制字符串 |
| 用户角色 | TEXT | 5 | 用户权限级别 | 'admin' 或 'user' |
| 用户状态 | TEXT | 4 | 账户状态 | '活跃' 或 '已暂停' |
| 存储配额 | REAL | - | 用户存储空间上限 | 单位：GB，默认50.0 |
| 已用存储 | REAL | - | 用户已使用存储空间 | 单位：GB，默认0.0 |
| 所属用户组ID | TEXT | 可变 | 用户所属组标识 | 可为空 |

### 1.2 文件相关数据项

| 数据项名称 | 数据类型 | 长度 | 说明 | 取值范围 |
|-----------|---------|------|------|---------|
| 文件ID | INTEGER | - | 文件唯一标识符 | 自增整数 |
| 文件名 | TEXT | 可变 | 文件显示名称 | 1-255个字符 |
| 文件大小 | INTEGER | - | 文件大小（字节） | 0 到 5GB |
| MIME类型 | TEXT | 可变 | 文件媒体类型 | 如：'image/png', 'application/pdf' |
| 存储键值 | TEXT | 可变 | R2对象存储的Key | 格式：用户ID/文件名_时间戳 |
| 用户ID | TEXT | 可变 | 文件所有者 | 外键，关联users表 |
| 父文件夹ID | INTEGER | - | 父文件夹标识 | 可为NULL（根目录） |
| 文件路径 | TEXT | 可变 | 文件的完整路径 | 如：'/folder1/file.pdf' |
| 文件类型 | TEXT | 10 | 文件分类 | 'folder', 'pdf', 'image', 'video', 'zip', 'code' |
| 收藏状态 | INTEGER | 1 | 是否收藏 | 0（未收藏）或1（已收藏） |
| 下载次数 | INTEGER | - | 文件下载计数 | 默认0 |
| 创建时间 | INTEGER | - | Unix时间戳 | 自1970-01-01的秒数 |
| 更新时间 | INTEGER | - | Unix时间戳 | 自1970-01-01的秒数 |

### 1.3 分享相关数据项

| 数据项名称 | 数据类型 | 长度 | 说明 | 取值范围 |
|-----------|---------|------|------|---------|
| 分享ID | TEXT | 可变 | 分享记录唯一标识 | 格式：share_时间戳 |
| 文件ID | INTEGER | - | 被分享的文件 | 外键，关联files表 |
| 用户ID | TEXT | 可变 | 分享创建者 | 外键，关联users表 |
| 分享码 | TEXT | 6 | 6位提取码 | 大写字母和数字，唯一 |
| 有效期天数 | INTEGER | - | 分享有效期 | 1-30天，默认7天 |
| 创建时间 | INTEGER | - | Unix时间戳 | 自1970-01-01的秒数 |
| 过期时间 | INTEGER | - | Unix时间戳 | 创建时间 + 有效期天数 |
| 访问次数 | INTEGER | - | 分享链接访问计数 | 默认0 |
| 最大访问次数 | INTEGER | - | 访问次数上限 | 可为NULL（无限制） |

### 1.4 用户组相关数据项

| 数据项名称 | 数据类型 | 长度 | 说明 | 取值范围 |
|-----------|---------|------|------|---------|
| 用户组ID | TEXT | 可变 | 用户组唯一标识 | 格式：grp_时间戳_随机字符串 |
| 组名称 | TEXT | 可变 | 用户组显示名称 | 1-50个字符 |
| 组描述 | TEXT | 可变 | 用户组说明 | 可为空 |
| 存储配额 | REAL | - | 组存储空间上限 | 单位：GB，默认50.0 |
| 最大用户数 | INTEGER | - | 组内最大用户数 | 可为NULL（无限制） |
| 当前用户数 | INTEGER | - | 组内当前用户数 | 默认0 |
| 权限列表 | TEXT | 可变 | JSON格式的权限数组 | 如：'["upload", "share"]' |
| 创建时间 | INTEGER | - | Unix时间戳 | 自1970-01-01的秒数 |
| 更新时间 | INTEGER | - | Unix时间戳 | 自1970-01-01的秒数 |

### 1.5 系统日志相关数据项

| 数据项名称 | 数据类型 | 长度 | 说明 | 取值范围 |
|-----------|---------|------|------|---------|
| 日志ID | INTEGER | - | 日志记录唯一标识 | 自增整数 |
| 操作类型 | TEXT | 可变 | 操作名称 | 如：'文件上传', '用户登录' |
| 用户ID | TEXT | 可变 | 操作者标识 | 可为NULL（系统操作） |
| 用户名 | TEXT | 可变 | 操作者名称 | 可为NULL |
| 操作状态 | TEXT | 2 | 操作结果 | '成功', '警告', '失败' |
| 操作详情 | TEXT | 可变 | 操作描述信息 | 可为空 |
| IP地址 | TEXT | 可变 | 操作者IP | IPv4或IPv6格式 |
| 文件ID | INTEGER | - | 关联的文件 | 可为NULL |
| 文件名 | TEXT | 可变 | 关联的文件名 | 可为空 |
| 创建时间 | INTEGER | - | Unix时间戳 | 自1970-01-01的秒数 |

## 2. 数据结构说明

### 2.1 用户表 (users)

**主键**: id  
**唯一约束**: email  
**外键**: group_id → user_groups(id)

### 2.2 文件表 (files)

**主键**: id  
**外键**: 
- user_id → users(id) ON DELETE CASCADE
- parent_id → files(id) ON DELETE CASCADE

**索引**:
- idx_files_user_id (user_id)
- idx_files_parent_id (parent_id)
- idx_files_path (path)

### 2.3 分享表 (shares)

**主键**: id  
**唯一约束**: share_code  
**外键**:
- file_id → files(id) ON DELETE CASCADE
- user_id → users(id) ON DELETE CASCADE

**索引**:
- idx_shares_code (share_code)
- idx_shares_file_id (file_id)
- idx_shares_user_id (user_id)

### 2.4 用户组表 (user_groups)

**主键**: id

### 2.5 系统日志表 (system_logs)

**主键**: id  
**外键**:
- user_id → users(id) ON DELETE SET NULL
- file_id → files(id) ON DELETE SET NULL

**索引**:
- idx_logs_created_at (created_at)

## 3. 数据流说明

### 3.1 数据输入流

- **用户注册**: 用户名、邮箱、密码 → users表
- **文件上传**: 文件元数据 → files表，文件实体 → R2存储
- **创建分享**: 文件ID、有效期 → shares表
- **系统操作**: 操作记录 → system_logs表

### 3.2 数据输出流

- **文件列表查询**: files表 → 文件元数据列表
- **分享验证**: shares表 → 文件访问权限
- **系统统计**: 多表聚合 → 统计数据
- **日志查询**: system_logs表 → 操作历史

### 3.3 数据存储流

- **元数据存储**: 数据库表（D1）
- **文件实体存储**: 对象存储（R2）
- **索引存储**: 数据库索引（D1）

## 4. 数据完整性约束

### 4.1 实体完整性

- 所有表都有主键约束
- 主键值唯一且非空

### 4.2 参照完整性

- 外键约束确保数据一致性
- 级联删除：删除用户时自动删除其文件和分享
- 级联置空：删除用户时日志中的user_id置为NULL

### 4.3 用户定义完整性

- 角色字段：只能为'admin'或'user'
- 状态字段：只能为'活跃'或'已暂停'
- 文件类型：只能为预定义的类型
- 分享码：6位，唯一
- 存储配额：必须大于0

## 5. 数据安全说明

### 5.1 敏感数据

- **密码**: 使用SHA-256哈希存储，不存储明文
- **文件内容**: 存储在R2，通过预签名URL访问
- **用户信息**: 通过JWT认证保护

### 5.2 访问控制

- 用户只能访问自己的文件
- 管理员可以访问所有数据
- 分享通过提取码验证访问权限

